<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ đối soát hóa đơn</title>
    <!-- Tải Tailwind CSS từ CDN để tạo kiểu dáng -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Analytics - Giữ nguyên nếu bạn muốn theo dõi -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1ZG44VNZQ9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-1ZG44VNZQ9');
    </script>

    <style>
        /* CSS cho hiệu ứng nhấp nháy của cảnh báo */
        @keyframes blinker { 
            50% { opacity: 0.7; } 
        }
        .blinking-warning { 
            animation: blinker 1.5s linear infinite; 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8">

    <div class="w-full max-w-2xl bg-white rounded-lg shadow-xl p-8">
        <!-- Phần Logo và Tên Công Ty -->
        <div class="flex items-center justify-center space-x-4 mb-6">
            <!-- Đã cập nhật để tham chiếu đến Logo.png trong thư mục "static" thông qua Flask url_for -->
            <img src="{{ url_for('static', filename='Logo.png') }}" alt="Logo Công Ty" class="h-20"> 
            <div class="text-center">
                <h2 class="text-xl font-bold text-red-600 leading-tight">CÔNG TY CỔ PHẦN XĂNG DẦU</h2>
                <h2 class="text-xl font-bold text-red-600 leading-tight">DẦU KHÍ NAM ĐỊNH</h2>
            </div>
        </div>
        
        <!-- Tiêu đề chính của ứng dụng -->
        <h1 class="text-base font-bold text-center text-blue-400 mb-6">Công cụ đối soát bảng kê hóa đơn điện tử với Cơ quan Thuế</h1>

        <!-- Khung Hướng dẫn sử dụng mới -->
        <div class="bg-blue-50 border border-blue-200 text-blue-800 p-6 rounded-md mb-6">
            <h2 class="text-lg font-bold text-blue-700 mb-3">Hướng dẫn sử dụng:</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>
                    <span class="font-semibold">Bước 1: Tải lên file bảng kê từ Cơ quan Thuế.</span>
                    <p class="text-sm ml-4">Chọn file Excel bảng kê hóa đơn mà bạn tải về từ hệ thống của Cơ quan Thuế.</p>
                </li>
                <li>
                    <span class="font-semibold">Bước 2: Tải lên file bảng kê HĐĐT.</span>
                    <p class="text-sm ml-4">Chọn file Excel bảng kê hóa đơn điện tử được xuất ra từ hệ thống HĐĐT của công ty bạn.</p>
                </li>
                <li>
                    <span class="font-semibold">Bước 3: Thực hiện đối soát.</span>
                    <p class="text-sm ml-4">Nhấn nút "Thực hiện Đối soát" để bắt đầu quá trình so sánh dữ liệu. Hệ thống sẽ phân tích và tìm ra các sai lệch.</p>
                </li>
                <li>
                    <span class="font-semibold">Bước 4: Xem và tải kết quả.</span>
                    <p class="text-sm ml-4">Sau khi đối soát hoàn tất, bạn sẽ thấy tóm tắt kết quả trên màn hình. Nếu có sai lệch, nút "Tải về kết quả đối soát chi tiết" sẽ xuất hiện để bạn tải file Excel chứa thông tin chi tiết.</p>
                </li>
            </ol>
            <p class="text-center text-red-600 font-bold mt-4 p-2 border border-red-400 rounded-md blinking-warning">
                Do giới hạn của dung lượng và tốc độ xử lý, bạn chỉ nên đối soát dữ liệu hóa đơn của 1 đến 2 ngày trong 1 lần đối soát.
            </p>
        </div>
        
        <!-- Vùng thông báo -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-md 
                        {% if category == 'danger' %} bg-red-100 border border-red-400 text-red-700
                        {% elif category == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-700
                        {% else %} bg-green-100 border border-green-400 text-green-700
                        {% endif %}" role="alert">
                        {{ message | safe }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Form chính để tải lên hai file và thực hiện đối soát -->
        <form id="compareForm" action="/compare_invoices" method="post" enctype="multipart/form-data" class="space-y-6">
            
            <!-- Input để tải lên file bảng kê từ Cơ quan Thuế -->
            <div>
                <label for="tax_invoice_file" class="block text-lg font-medium text-gray-700 mb-2">1. Tải lên file bảng kê từ Cơ quan Thuế:</label>
                <input type="file" name="tax_invoice_file" id="tax_invoice_file" required class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-50 file:text-indigo-700
                    hover:file:bg-indigo-100
                ">
            </div>

            <!-- Input để tải lên file bảng kê HĐĐT -->
            <div>
                <label for="e_invoice_file" class="block text-lg font-medium text-gray-700 mb-2">2. Tải lên file bảng kê HĐĐT:</label>
                <input type="file" name="e_invoice_file" id="e_invoice_file" required class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-50 file:text-indigo-700
                    hover:file:bg-indigo-100
                ">
            </div>

            <!-- Nút để thực hiện đối soát -->
            <div>
                <button type="submit" id="submit-compare-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Thực hiện Đối soát
                </button>
                <div id="loading-indicator" class="flex justify-center items-center mt-3 hidden">
                    <div class="loader mr-2"></div> Đang xử lý...
                </div>
            </div>
        </form>

        <!-- Phần hiển thị kết quả đối soát tổng thể -->
        <div id="comparison-results" class="mt-8 pt-4 border-t {% if not reconciliation_data %}hidden{% endif %}">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Kết quả đối soát tổng thể:</h2>
            <div id="discrepancy-summary" class="bg-red-100 border border-red-400 text-red-700 p-4 rounded-md mb-4">
                <p class="font-semibold">Số hóa đơn không khớp: <span id="mismatched-count">{{ reconciliation_data.mismatched_invoices | length if reconciliation_data and reconciliation_data.mismatched_invoices else 0 }}</span></p>
                <ul id="mismatched-list" class="list-disc list-inside mt-2">
                    {% if reconciliation_data and reconciliation_data.mismatched_invoices %}
                        {% for invoice in reconciliation_data.mismatched_invoices %}
                            <li>{{ invoice }}</li>
                        {% endfor %}
                    {% else %}
                        <li>Không tìm thấy hóa đơn không khớp.</li>
                    {% endif %}
                </ul>
            </div>
            <div id="match-summary" class="bg-green-100 border border-green-400 text-green-700 p-4 rounded-md mb-4">
                <p class="font-semibold">Số hóa đơn khớp: <span id="matched-count-display">{{ reconciliation_data.matched_count if reconciliation_data else 0 }}</span></p>
            </div>
            <!-- Nút tải về kết quả chi tiết -->
            <button type="button" id="download-results-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mt-4 {% if not reconciliation_data or not reconciliation_data.download_url %}hidden{% endif %}">
                Tải về kết quả đối soát chi tiết
            </button>
        </div>

        <div class="mt-8 border-t pt-4 text-center">
            <p class="text-xs text-gray-600">Nếu gặp khó khăn, vui lòng liên hệ tác giả để được hỗ trợ.</p>
            <p class="text-xs text-gray-600">Bản quyền thuộc về Nguyễn Trọng Hoàn - 0902069469</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const compareForm = document.getElementById('compareForm');
            const submitCompareBtn = document.getElementById('submit-compare-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            const downloadResultsBtn = document.getElementById('download-results-btn');
            const comparisonResultsDiv = document.getElementById('comparison-results');
            const mismatchedCountSpan = document.getElementById('mismatched-count');
            const mismatchedList = document.getElementById('mismatched-list');
            const matchedCountDisplay = document.getElementById('matched-count-display');
            const discrepancySummaryDiv = document.getElementById('discrepancy-summary');
            const matchSummaryDiv = document.getElementById('match-summary');

            // Hàm để cập nhật hiển thị kết quả trên trang
            function updateResultsDisplay(data) {
                // Luôn hiển thị phần tóm tắt sai lệch, cập nhật nội dung
                discrepancySummaryDiv.classList.remove('hidden'); 
                mismatchedCountSpan.textContent = data.mismatched_invoices ? data.mismatched_invoices.length : 0;
                mismatchedList.innerHTML = '';
                if (data.mismatched_invoices && data.mismatched_invoices.length > 0) {
                    data.mismatched_invoices.forEach(invoice => {
                        const listItem = document.createElement('li');
                        listItem.textContent = invoice;
                        mismatchedList.appendChild(listItem);
                    });
                } else {
                    mismatchedList.innerHTML = '<li>Không tìm thấy hóa đơn không khớp.</li>';
                }

                // Luôn hiển thị phần tóm tắt khớp, cập nhật nội dung
                matchSummaryDiv.classList.remove('hidden');
                matchedCountDisplay.textContent = data.matched_count || 0;

                if (data.download_url) {
                    downloadResultsBtn.classList.remove('hidden');
                    // Gán trực tiếp URL vào href của nút để tải về
                    downloadResultsBtn.onclick = () => window.location.href = data.download_url;
                } else {
                    downloadResultsBtn.classList.add('hidden'); // Ẩn nút nếu không có URL tải về
                }
            }

            // Xử lý trạng thái ban đầu khi trang tải (dựa trên dữ liệu Flask nếu có)
            // Đảm bảo nút tải về được thiết lập đúng ngay từ đầu
            const initialReconciliationData = {{ reconciliation_data | default({}) | tojson }};
            if (Object.keys(initialReconciliationData).length > 0) {
                comparisonResultsDiv.classList.remove('hidden');
                updateResultsDisplay(initialReconciliationData);
            } else {
                comparisonResultsDiv.classList.add('hidden');
            }


            // Xử lý gửi form cho việc tải lên file ban đầu
            if (compareForm) {
                compareForm.addEventListener('submit', async function(event) {
                    event.preventDefault(); // Ngăn chặn gửi form mặc định

                    // Hiển thị chỉ báo tải
                    submitCompareBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    submitCompareBtn.disabled = true;
                    loadingIndicator.classList.remove('hidden');
                    
                    const formData = new FormData(compareForm);

                    try {
                        const response = await fetch(compareForm.action, {
                            method: compareForm.method,
                            body: formData
                        });

                        const result = await response.json(); // Luôn mong đợi phản hồi JSON từ Flask

                        if (response.ok) {
                            // Đối soát thành công, cập nhật hiển thị kết quả
                            updateResultsDisplay(result);
                            comparisonResultsDiv.classList.remove('hidden');
                            alert('Đối soát thành công!');
                            // Xóa giá trị các trường input file sau khi xử lý thành công
                            document.getElementById('tax_invoice_file').value = '';
                            document.getElementById('e_invoice_file').value = '';
                        } else {
                            // Xử lý lỗi từ Flask (ví dụ: lỗi xác thực)
                            alert('Lỗi khi đối soát: ' + (result.message || response.statusText));
                            comparisonResultsDiv.classList.add('hidden'); // Ẩn kết quả khi có lỗi
                        }
                    } catch (error) {
                        console.error('Lỗi mạng hoặc server:', error);
                        alert('Không thể kết nối đến máy chủ. Vui lòng thử lại sau.');
                        comparisonResultsDiv.classList.add('hidden'); // Ẩn kết quả khi có lỗi
                    } finally {
                        // Ẩn chỉ báo tải
                        submitCompareBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitCompareBtn.disabled = false;
                        loadingIndicator.classList.add('hidden');
                    }
                });
            }
        });
    </script>
</body>
</html>
